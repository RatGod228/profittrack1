<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ProfitTrack - –£—á–µ—Ç –∑–∞–∫—É–ø–æ–∫ –∏ –ø—Ä–æ–¥–∞–∂</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root {
      --bg-primary: #f9fafb;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --input-bg: #ffffff;
      --input-border: #d1d5db;
      --shadow: rgba(0,0,0,0.1);
      --gradient-start: #667eea;
      --gradient-end: #764ba2;
    }
    [data-theme="dark"] {
      --bg-primary: #111827;
      --bg-secondary: #1f2937;
      --bg-card: #374151;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --border-color: #4b5563;
      --input-bg: #374151;
      --input-border: #4b5563;
      --shadow: rgba(0,0,0,0.3);
      --gradient-start: #4c51bf;
      --gradient-end: #7c3aed;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); transition: background 0.3s, color 0.3s; }
    
    .landing-hero { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 80px 24px; text-align: center; }
    .landing-hero h1 { font-size: 48px; margin-bottom: 16px; }
    .landing-hero p { font-size: 20px; opacity: 0.9; max-width: 600px; margin: 0 auto 32px; }
    .landing-stats { display: flex; justify-content: center; gap: 48px; flex-wrap: wrap; margin-top: 48px; }
    .landing-stat { text-align: center; }
    .landing-stat-value { font-size: 36px; font-weight: bold; }
    .landing-stat-label { font-size: 14px; opacity: 0.8; }
    .landing-btn { padding: 16px 32px; background: white; color: #667eea; border: none; border-radius: 8px; font-size: 18px; font-weight: 600; cursor: pointer; margin: 8px; }
    .landing-btn-outline { background: transparent; color: white; border: 2px solid white; }
    
    .landing-section { padding: 64px 24px; max-width: 1200px; margin: 0 auto; }
    .landing-section h2 { text-align: center; font-size: 32px; margin-bottom: 48px; color: var(--text-primary); }
    .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; }
    .feature-card { background: var(--bg-card); padding: 32px; border-radius: 12px; box-shadow: 0 4px 6px var(--shadow); text-align: center; }
    .feature-icon { font-size: 48px; margin-bottom: 16px; }
    .feature-card h3 { font-size: 20px; margin-bottom: 12px; color: var(--text-primary); }
    .feature-card p { color: var(--text-secondary); line-height: 1.6; }
    
    .screenshots-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
    .screenshot-card { background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px var(--shadow); }
    .screenshot-img { width: 100%; height: 200px; background: linear-gradient(135deg, #10b981, #3b82f6); display: flex; align-items: center; justify-content: center; font-size: 64px; }
    .screenshot-content { padding: 20px; }
    .screenshot-content h3 { font-size: 18px; margin-bottom: 8px; color: var(--text-primary); }
    .screenshot-content p { color: var(--text-secondary); font-size: 14px; }
    
    .reviews-section { background: var(--bg-secondary); }
    .reviews-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
    .review-card { background: var(--bg-card); padding: 24px; border-radius: 12px; box-shadow: 0 2px 4px var(--shadow); }
    .review-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .review-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #3b82f6); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold; }
    .review-info h4 { color: var(--text-primary); margin-bottom: 4px; }
    .review-stars { color: #fbbf24; }
    .review-text { color: var(--text-secondary); line-height: 1.6; }
    .review-form { background: var(--bg-card); padding: 24px; border-radius: 12px; max-width: 500px; margin: 32px auto 0; }
    .review-form h3 { margin-bottom: 16px; color: var(--text-primary); }
    .star-rating { display: flex; gap: 8px; margin-bottom: 16px; }
    .star-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #d1d5db; }
    .star-btn.active { color: #fbbf24; }
    
    .landing-footer { background: #1f2937; color: white; padding: 48px 24px; text-align: center; }
    
    .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%); padding: 24px; }
    .auth-card { max-width: 420px; width: 100%; background: var(--bg-card); border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); overflow: hidden; }
    .auth-header { background: linear-gradient(135deg, #10b981, #3b82f6); padding: 32px; text-align: center; color: white; }
    .auth-header h1 { font-size: 24px; font-weight: bold; margin-bottom: 12px; }
    .auth-form { padding: 32px; }
    .auth-tabs { display: flex; gap: 8px; margin-bottom: 24px; }
    .auth-tab { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; background: var(--bg-primary); color: var(--text-primary); }
    .auth-tab.active { background: #3b82f6; color: white; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; color: var(--text-primary); }
    .form-group label .required { color: #dc2626; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; border: 1px solid var(--input-border); border-radius: 8px; font-size: 14px; background: var(--input-bg); color: var(--text-primary); }
    .password-input-wrapper { position: relative; }
    .password-input-wrapper input { padding-right: 40px; }
    .password-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text-secondary); padding: 0; }
    .password-toggle:hover { color: var(--text-primary); }
    .auth-error { background: #fee2e2; color: #dc2626; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
    .auth-success { background: #d1fae5; color: #059669; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
    .info-box { background: #dbeafe; color: #1e40af; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
    .auth-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #10b981, #3b82f6); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .auth-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .forgot-password { text-align: center; margin-top: 16px; }
    .forgot-password button { background: none; border: none; color: #3b82f6; cursor: pointer; font-size: 14px; }
    .back-to-login { text-align: center; margin-top: 16px; }
    .back-to-login button { background: none; border: none; color: #6b7280; cursor: pointer; font-size: 14px; }
    
    .app-header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); box-shadow: 0 1px 2px var(--shadow); position: sticky; top: 0; z-index: 100; }
    .app-header-content { max-width: 1280px; margin: 0 auto; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-primary); padding: 8px; border-radius: 8px; }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon { background: linear-gradient(135deg, #10b981, #3b82f6); padding: 8px; border-radius: 8px; font-size: 24px; }
    .logout-btn { padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    
    .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; }
    .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 300px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); z-index: 201; padding: 24px; overflow-y: auto; transform: translateX(-100%); transition: transform 0.3s ease; }
    .sidebar.open { transform: translateX(0); }
    .sidebar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
    .close-sidebar { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); }
    .sidebar-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; cursor: pointer; color: var(--text-primary); background: none; border: none; width: 100%; text-align: left; font-size: 16px; }
    .sidebar-item:hover { background: var(--bg-primary); }
    .sidebar-divider { height: 1px; background: var(--border-color); margin: 16px 0; }
    .theme-toggle { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; }
    .toggle-switch { position: relative; width: 50px; height: 26px; background: #6b7280; border-radius: 13px; cursor: pointer; }
    .toggle-switch.active { background: #3b82f6; }
    .toggle-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.3s; }
    .toggle-switch.active::after { transform: translateX(24px); }
    
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 300; padding: 24px; }
    .modal-content { background: var(--bg-card); border-radius: 16px; padding: 32px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); }
    .profile-avatar { width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #3b82f6); display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; }
    
    .main-content { max-width: 1280px; margin: 0 auto; padding: 24px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--bg-card); border-radius: 8px; padding: 16px; display: flex; justify-content: space-between; align-items: center; border: 2px solid transparent; }
    .stat-card.purchases { border-color: #a7f3d0; }
    .stat-card.sales { border-color: #bfdbfe; }
    .stat-card.profit { border-color: #a7f3d0; }
    .stat-card.profit.negative { border-color: #fecaca; }
    .stat-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 4px; }
    .stat-value { font-size: 24px; font-weight: bold; }
    .stat-value.purchases { color: #059669; }
    .stat-value.sales { color: #2563eb; }
    .stat-value.profit { color: #059669; }
    .stat-value.profit.negative { color: #dc2626; }
    .stat-icon { padding: 12px; border-radius: 8px; font-size: 24px; }
    .stat-icon.purchases { background: #d1fae5; }
    .stat-icon.sales { background: #dbeafe; }
    .stat-icon.profit { background: #d1fae5; }
    .stat-icon.profit.negative { background: #fee2e2; }
    
    .tabs { display: flex; background: var(--bg-card); border-radius: 8px; box-shadow: 0 1px 3px var(--shadow); margin-bottom: 24px; }
    .tab { flex: 1; padding: 12px 24px; border: none; background: transparent; cursor: pointer; font-weight: 500; color: var(--text-secondary); }
    .tab.active { background: var(--bg-primary); border-bottom: 2px solid #3b82f6; font-weight: 600; color: var(--text-primary); }
    .tab-content { background: var(--bg-card); border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px var(--shadow); }
    
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; }
    .form-card { border-radius: 8px; padding: 20px; background: var(--bg-card); }
    .form-card.purchase { border: 2px solid #10b981; border-left: 6px solid #10b981; }
    .form-card.sale { border: 2px solid #3b82f6; border-left: 6px solid #3b82f6; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn { padding: 12px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .btn-primary { background: #059669; color: white; }
    .btn-secondary { background: #2563eb; color: white; }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .summary-box { background: #d1fae5; padding: 12px; border-radius: 6px; margin-top: 12px; }
    .summary-box.negative { background: #fee2e2; }
    
    .table-container { overflow-x: auto; max-height: 400px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary); }
    th { position: sticky; top: 0; background: var(--bg-card); }
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
    .badge-success { background: #059669; color: white; }
    .badge-danger { background: #dc2626; color: white; }
    .badge-info { background: #d1fae5; color: #059669; }
    .badge-warning { background: #fee2e2; color: #dc2626; }
    .product-img { width: 40px; height: 40px; object-fit: cover; border-radius: 6px; cursor: pointer; }
    .product-placeholder { width: 40px; height: 40px; background: var(--bg-primary); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .sell-btn { padding: 4px 10px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .delete-btn { background: none; border: none; color: #dc2626; cursor: pointer; font-size: 16px; }
    .edit-btn { padding: 2px 6px; background: #3b82f6; color: white; border: none; border-radius: 3px; font-size: 10px; cursor: pointer; }
    .notes-box { font-size: 11px; color: #8b5cf6; margin-top: 4px; font-style: italic; }
    
    .branch-selector { background: var(--bg-card); border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px var(--shadow); }
    .branch-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .branch-select { padding: 8px 12px; border: 1px solid var(--input-border); border-radius: 6px; font-size: 14px; min-width: 200px; background: var(--input-bg); color: var(--text-primary); }
    .btn-small { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    
    .loading { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--bg-primary); text-align: center; }
    .loading-icon { font-size: 48px; margin-bottom: 16px; }
    
    .preview-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 400; padding: 24px; }
    .preview-modal img { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; }
    .modal-close-btn { position: absolute; top: 16px; right: 16px; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    
    const THEME_KEY = 'profittrack_theme';
    const TOKEN_KEY = 'profittrack_token';
    
    const FAKE_REVIEWS = [
      { id: '1', name: '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ö.', rating: 5, text: '–û—Ç–ª–∏—á–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ! –¢–µ–ø–µ—Ä—å –≤—Å–µ–≥–¥–∞ –∑–Ω–∞—é —Å–≤–æ—é –ø—Ä–∏–±—ã–ª—å.', date: '2024-01-15' },
      { id: '2', name: '–ú–∞—Ä–∏—è –°.', rating: 5, text: '–ü–æ–ª—å–∑—É—é—Å—å —É–∂–µ –ø–æ–ª–≥–æ–¥–∞. –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ!', date: '2024-02-03' },
      { id: '3', name: '–î–º–∏—Ç—Ä–∏–π –í.', rating: 4, text: '–•–æ—Ä–æ—à–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞.', date: '2024-02-20' },
      { id: '4', name: '–ï–ª–µ–Ω–∞ –ü.', rating: 5, text: '–°–∞–º–æ–µ —É–¥–æ–±–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É—á–µ—Ç–∞!', date: '2024-03-08' },
      { id: '5', name: '–ò–≥–æ—Ä—å –ú.', rating: 5, text: '–¢–µ–º–Ω–∞—è —Ç–µ–º–∞ - —ç—Ç–æ —Ç–æ, —á—Ç–æ –º–Ω–µ –±—ã–ª–æ –Ω—É–∂–Ω–æ!', date: '2024-03-25' },
      { id: '6', name: '–ê–Ω–Ω–∞ –õ.', rating: 4, text: '–£–¥–æ–±–Ω–æ –≤–µ—Å—Ç–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ç–æ–∫ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π.', date: '2024-04-12' },
    ];

    function App() {
      const [theme, setTheme] = useState('light');
      const [token, setToken] = useState(null);
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [showLanding, setShowLanding] = useState(true);
      
      const [authMode, setAuthMode] = useState('login');
      const [loginInput, setLoginInput] = useState('');
      const [passwordInput, setPasswordInput] = useState('');
      const [userName, setUserName] = useState('');
      const [emailInput, setEmailInput] = useState('');
      const [authError, setAuthError] = useState('');
      const [authSuccess, setAuthSuccess] = useState('');
      const [authLoading, setAuthLoading] = useState(false);
      
      const [showForgotPassword, setShowForgotPassword] = useState(false);
      const [resetEmail, setResetEmail] = useState('');
      const [resetCode, setResetCode] = useState('');
      const [newResetPassword, setNewResetPassword] = useState('');
      const [resetStep, setResetStep] = useState(1);
      
      const [purchases, setPurchases] = useState([]);
      const [sales, setSales] = useState([]);
      const [branches, setBranches] = useState([]);
      const [currentBranchId, setCurrentBranchId] = useState('');
      const [reviews, setReviews] = useState(FAKE_REVIEWS);
      const [activeTab, setActiveTab] = useState('add');
      
      const [sidebarOpen, setSidebarOpen] = useState(false);
      const [showProfile, setShowProfile] = useState(false);
      const [showChangePassword, setShowChangePassword] = useState(false);
      const [currentPassword, setCurrentPassword] = useState('');
      const [newPassword, setNewPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [passwordSuccess, setPasswordSuccess] = useState('');
      const [passwordError, setPasswordError] = useState('');
      
      const [newBranchName, setNewBranchName] = useState('');
      const [showNewBranchForm, setShowNewBranchForm] = useState(false);
      
      const [purchaseName, setPurchaseName] = useState('');
      const [purchaseQty, setPurchaseQty] = useState('1');
      const [purchasePrice, setPurchasePrice] = useState('');
      const [purchaseDate, setPurchaseDate] = useState(new Date().toISOString().split('T')[0]);
      const [purchasePhoto, setPurchasePhoto] = useState('');
      const [purchaseNotes, setPurchaseNotes] = useState('');
      
      const [saleProduct, setSaleProduct] = useState('');
      const [saleQty, setSaleQty] = useState('1');
      const [salePurchasePrice, setSalePurchasePrice] = useState('');
      const [salePrice, setSalePrice] = useState('');
      const [saleDate, setSaleDate] = useState(new Date().toISOString().split('T')[0]);
      const [saleNotes, setSaleNotes] = useState('');
      
      const [quickSaleProduct, setQuickSaleProduct] = useState('');
      const [quickSalePhoto, setQuickSalePhoto] = useState('');
      const [quickSalePurchasePrice, setQuickSalePurchasePrice] = useState('');
      const [showQuickSale, setShowQuickSale] = useState(false);
      
      const [editingPurchaseId, setEditingPurchaseId] = useState('');
      const [editingSaleId, setEditingSaleId] = useState('');
      const [editNotes, setEditNotes] = useState('');
      
      const [previewPhoto, setPreviewPhoto] = useState('');
      const [showPreview, setShowPreview] = useState(false);
      
      const [newReviewRating, setNewReviewRating] = useState(0);
      const [newReviewText, setNewReviewText] = useState('');

      // Support system states
      const [faq, setFaq] = useState([]);
      const [tickets, setTickets] = useState([]);
      const [showSupport, setShowSupport] = useState(false);
      const [showNewTicket, setShowNewTicket] = useState(false);
      const [selectedTicket, setSelectedTicket] = useState(null);
      const [ticketSubject, setTicketSubject] = useState('');
      const [ticketMessage, setTicketMessage] = useState('');
      const [replyMessage, setReplyMessage] = useState('');
      const [aiChatOpen, setAiChatOpen] = useState(false);
      const [aiMessages, setAiMessages] = useState([{ from: 'ai', text: '–ü—Ä–∏–≤–µ—Ç! –Ø –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ProfitTrack. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?' }]);
      const [aiInput, setAiInput] = useState('');
      const [aiLoading, setAiLoading] = useState(false);
      const [expandedFAQ, setExpandedFAQ] = useState(null);

      // Password visibility states
      const [showPassword, setShowPassword] = useState(false);
      const [showCurrentPassword, setShowCurrentPassword] = useState(false);
      const [showNewPassword, setShowNewPassword] = useState(false);
      const [showConfirmPassword, setShowConfirmPassword] = useState(false);
      const [showResetPassword, setShowResetPassword] = useState(false);

      useEffect(() => {
        const savedTheme = localStorage.getItem(THEME_KEY);
        if (savedTheme) {
          setTheme(savedTheme);
          document.documentElement.setAttribute('data-theme', savedTheme);
        }
        const savedToken = localStorage.getItem(TOKEN_KEY);
        if (savedToken) {
          setToken(savedToken);
          loadUser(savedToken);
        } else {
          setLoading(false);
        }
      }, []);

      const loadUser = async (t) => {
        try {
          const res = await fetch('/api/user/profile', { headers: { 'Authorization': `Bearer ${t}` } });
          if (res.ok) {
            const userData = await res.json();
            setUser(userData);
            setShowLanding(false);
            loadData(t);
          } else {
            throw new Error('Invalid token');
          }
        } catch (e) {
          localStorage.removeItem(TOKEN_KEY);
          setToken(null);
        }
        setLoading(false);
      };
      
      const loadData = async (t) => {
        try {
          const [branchesRes, purchasesRes, salesRes, reviewsRes, faqRes, ticketsRes] = await Promise.all([
            fetch('/api/branches', { headers: { 'Authorization': `Bearer ${t}` } }),
            fetch('/api/purchases', { headers: { 'Authorization': `Bearer ${t}` } }),
            fetch('/api/sales', { headers: { 'Authorization': `Bearer ${t}` } }),
            fetch('/api/reviews'),
            fetch('/api/faq'),
            fetch('/api/tickets', { headers: { 'Authorization': `Bearer ${t}` } })
          ]);
          const branchesData = await branchesRes.json();
          const purchasesData = await purchasesRes.json();
          const salesData = await salesRes.json();
          const reviewsData = await reviewsRes.json();
          const faqData = await faqRes.json();
          const ticketsData = await ticketsRes.json();
          
          setBranches(branchesData);
          setPurchases(purchasesData);
          setSales(salesData);
          if (reviewsData && reviewsData.length > 0) setReviews(reviewsData);
          setFaq(faqData);
          setTickets(ticketsData);
          if (branchesData.length > 0 && !currentBranchId) setCurrentBranchId(branchesData[0].id);
        } catch (e) {
          console.error('Load data error:', e);
        }
      };

      const toggleTheme = () => {
        const newTheme = theme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem(THEME_KEY, newTheme);
      };

      const handleLogin = async () => {
        setAuthError('');
        setAuthLoading(true);
        try {
          const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ login: loginInput, password: passwordInput })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error);
          localStorage.setItem(TOKEN_KEY, data.token);
          setToken(data.token);
          setUser(data.user);
          setShowLanding(false);
          setLoginInput('');
          setPasswordInput('');
          loadData(data.token);
        } catch (e) {
          setAuthError(e.message);
        }
        setAuthLoading(false);
      };

      const handleRegister = async () => {
        setAuthError('');
        if (!emailInput.trim()) {
          setAuthError('Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è');
          return;
        }
        setAuthLoading(true);
        try {
          const res = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: userName, login: loginInput, password: passwordInput, email: emailInput })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error);
          localStorage.setItem(TOKEN_KEY, data.token);
          setToken(data.token);
          setUser(data.user);
          setShowLanding(false);
          setLoginInput('');
          setPasswordInput('');
          setUserName('');
          setEmailInput('');
          loadData(data.token);
        } catch (e) {
          setAuthError(e.message);
        }
        setAuthLoading(false);
      };

      const handleForgotPassword = async () => {
        setAuthError('');
        setAuthSuccess('');
        if (!resetEmail.trim()) {
          setAuthError('–í–≤–µ–¥–∏—Ç–µ email');
          return;
        }
        setAuthLoading(true);
        try {
          console.log('Sending forgot password request...');
          const res = await fetch('/api/auth/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: resetEmail })
          });
          console.log('Response status:', res.status);
          const data = await res.json();
          console.log('Response data:', data);
          if (!res.ok) throw new Error(data.error);
          setAuthSuccess(data.message);
          setResetStep(2);
        } catch (e) {
          console.error('Forgot password error:', e);
          setAuthError(e.message);
        } finally {
          setAuthLoading(false);
        }
      };

      const handleVerifyCode = async () => {
        setAuthError('');
        setAuthLoading(true);
        try {
          const res = await fetch('/api/auth/verify-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: resetEmail, code: resetCode })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error);
          setResetStep(3);
          setAuthSuccess('');
        } catch (e) {
          setAuthError(e.message);
        }
        setAuthLoading(false);
      };

      const handleResetPassword = async () => {
        setAuthError('');
        if (!newResetPassword || newResetPassword.length < 4) {
          setAuthError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞');
          return;
        }
        if (newResetPassword !== confirmPassword) {
          setAuthError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
          return;
        }
        setAuthLoading(true);
        try {
          const res = await fetch('/api/auth/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: resetEmail, code: resetCode, newPassword: newResetPassword })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error);
          setAuthSuccess(data.message);
          setTimeout(() => {
            setShowForgotPassword(false);
            setResetStep(1);
            setResetEmail('');
            setResetCode('');
            setNewResetPassword('');
            setAuthSuccess('');
          }, 2000);
        } catch (e) {
          setAuthError(e.message);
        }
        setAuthLoading(false);
      };

      const handleChangePassword = async () => {
        setPasswordError('');
        setPasswordSuccess('');
        if (!currentPassword || !newPassword || !confirmPassword) {
          setPasswordError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
          return;
        }
        if (newPassword !== confirmPassword) {
          setPasswordError('–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
          return;
        }
        if (newPassword.length < 4) {
          setPasswordError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞');
          return;
        }
        try {
          const res = await fetch('/api/auth/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ currentPassword, newPassword })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error);
          setPasswordSuccess(data.message);
          setCurrentPassword('');
          setNewPassword('');
          setConfirmPassword('');
        } catch (e) {
          setPasswordError(e.message);
        }
      };

      const handleLogout = () => {
        localStorage.removeItem(TOKEN_KEY);
        setToken(null);
        setUser(null);
        setPurchases([]);
        setSales([]);
        setBranches([]);
        setCurrentBranchId('');
        setSidebarOpen(false);
        setShowLanding(true);
      };

      const handleUpdateEmail = async () => {
        try {
          const res = await fetch('/api/user/profile', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ email: emailInput })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error);
          setUser({ ...user, email: data.email });
          alert('Email –æ–±–Ω–æ–≤–ª–µ–Ω');
        } catch (e) {
          alert(e.message);
        }
      };

      const handlePhotoUpload = (e, setPhoto) => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 5 * 1024 * 1024) {
          alert('–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 5MB');
          return;
        }
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const maxWidth = 400, maxHeight = 400;
          let width = img.width, height = img.height;
          if (width > height) {
            if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; }
          } else {
            if (height > maxHeight) { width = Math.round((width * maxHeight) / height); height = maxHeight; }
          }
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          const base64 = canvas.toDataURL('image/jpeg', 0.8);
          setPhoto(base64);
          URL.revokeObjectURL(url);
        };
        img.src = url;
      };

      const createBranch = async () => {
        if (!newBranchName.trim()) return;
        try {
          const res = await fetch('/api/branches', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ name: newBranchName })
          });
          const newBranch = await res.json();
          if (!res.ok) throw new Error(newBranch.error);
          setBranches([...branches, newBranch]);
          setCurrentBranchId(newBranch.id);
          setNewBranchName('');
          setShowNewBranchForm(false);
        } catch (e) {
          alert(e.message);
        }
      };

      const deleteBranch = async (branchId) => {
        if (branches.length <= 1) {
          alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ç–∫—É');
          return;
        }
        if (confirm('–£–¥–∞–ª–∏—Ç—å –≤–µ—Ç–∫—É? –í—Å–µ –∑–∞–∫—É–ø–∫–∏ –∏ –ø—Ä–æ–¥–∞–∂–∏ –≤ —ç—Ç–æ–π –≤–µ—Ç–∫–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
          try {
            const res = await fetch(`/api/branches/${branchId}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!res.ok) throw new Error('Error');
            setBranches(branches.filter(b => b.id !== branchId));
            setPurchases(purchases.filter(p => p.branchId !== branchId));
            setSales(sales.filter(s => s.branchId !== branchId));
            if (currentBranchId === branchId) {
              const remaining = branches.filter(b => b.id !== branchId);
              setCurrentBranchId(remaining[0]?.id || '');
            }
          } catch (e) {
            alert(e.message);
          }
        }
      };

      const addPurchase = async () => {
        if (!purchaseName || !purchaseQty || !purchasePrice || !currentBranchId) return;
        try {
          const res = await fetch('/api/purchases', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({
              productName: purchaseName.trim(),
              quantity: parseInt(purchaseQty),
              price: parseFloat(purchasePrice),
              date: purchaseDate,
              branchId: currentBranchId,
              photo: purchasePhoto || undefined,
              notes: purchaseNotes.trim() || undefined
            })
          });
          const newPurchase = await res.json();
          if (!res.ok) throw new Error(newPurchase.error);
          setPurchases([newPurchase, ...purchases]);
          setPurchaseName('');
          setPurchaseQty('1');
          setPurchasePrice('');
          setPurchasePhoto('');
          setPurchaseNotes('');
        } catch (e) {
          alert(e.message);
        }
      };

      const addSale = async () => {
        if (!saleProduct || !saleQty || !salePrice || !currentBranchId) return;
        try {
          const res = await fetch('/api/sales', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({
              productName: saleProduct,
              quantity: parseInt(saleQty),
              salePrice: parseFloat(salePrice),
              date: saleDate,
              branchId: currentBranchId,
              notes: saleNotes.trim() || undefined
            })
          });
          const newSale = await res.json();
          if (!res.ok) throw new Error(newSale.error);
          setSales([newSale, ...sales]);
          await loadData(token);
          setSaleProduct('');
          setSaleQty('1');
          setSalePrice('');
          setSaleNotes('');
        } catch (e) {
          alert(e.message);
        }
      };

      const openQuickSale = (productName) => {
        const relevantPurchases = purchases.filter(p => 
          p.branchId === currentBranchId && 
          p.productName === productName && 
          p.remainingQty > 0
        );
        const totalRemaining = relevantPurchases.reduce((sum, p) => sum + p.remainingQty, 0);
        if (totalRemaining <= 0) {
          alert('–¢–æ–≤–∞—Ä –∑–∞–∫–æ–Ω—á–∏–ª—Å—è!');
          return;
        }
        const firstPurchase = relevantPurchases[0];
        setQuickSaleProduct(productName);
        setQuickSalePhoto(firstPurchase?.photo || '');
        setQuickSalePurchasePrice(firstPurchase?.price.toString() || '0');
        setSalePrice('');
        setSaleQty('1');
        setSaleNotes('');
        setSaleDate(new Date().toISOString().split('T')[0]);
        setShowQuickSale(true);
      };

      const addQuickSale = async () => {
        if (!quickSaleProduct || !saleQty || !salePrice) return;
        try {
          const res = await fetch('/api/sales', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({
              productName: quickSaleProduct,
              quantity: parseInt(saleQty),
              salePrice: parseFloat(salePrice),
              date: saleDate,
              branchId: currentBranchId,
              notes: saleNotes.trim() || undefined
            })
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error);
          }
          await loadData(token);
          setShowQuickSale(false);
          setQuickSaleProduct('');
          setQuickSalePhoto('');
          setQuickSalePurchasePrice('');
          setSalePrice('');
          setSaleQty('1');
          setSaleNotes('');
        } catch (e) {
          alert(e.message);
        }
      };

      const deletePurchase = async (id) => {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–∫—É–ø–∫—É?')) {
          try {
            await fetch(`/api/purchases/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
            });
            setPurchases(purchases.filter(p => p.id !== id));
          } catch (e) {
            alert(e.message);
          }
        }
      };

      const deleteSale = async (id) => {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—Ä–æ–¥–∞–∂—É?')) {
          try {
            await fetch(`/api/sales/${id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
            });
            setSales(sales.filter(s => s.id !== id));
          } catch (e) {
            alert(e.message);
          }
        }
      };

      const savePurchaseNotes = async (id) => {
        try {
          await fetch(`/api/purchases/${id}/notes`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ notes: editNotes })
          });
          setPurchases(purchases.map(p => p.id === id ? { ...p, notes: editNotes.trim() || undefined } : p));
          setEditingPurchaseId('');
          setEditNotes('');
        } catch (e) {
          alert(e.message);
        }
      };

      const saveSaleNotes = async (id) => {
        try {
          await fetch(`/api/sales/${id}/notes`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ notes: editNotes })
          });
          setSales(sales.map(s => s.id === id ? { ...s, notes: editNotes.trim() || undefined } : s));
          setEditingSaleId('');
          setEditNotes('');
        } catch (e) {
          alert(e.message);
        }
      };

      const handleAddReview = async () => {
        if (newReviewRating === 0) {
          alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–π—Ç–∏–Ω–≥');
          return;
        }
        if (!newReviewText.trim()) {
          alert('–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤');
          return;
        }
        try {
          const res = await fetch('/api/reviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ rating: newReviewRating, text: newReviewText.trim() })
          });
          const review = await res.json();
          if (!res.ok) throw new Error(review.error);
          setReviews([review, ...reviews]);
          setNewReviewRating(0);
          setNewReviewText('');
        } catch (e) {
          alert(e.message);
        }
      };

      const formatCurrency = (amount) => {
        return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(amount || 0);
      };

      // Support system functions
      const handleCreateTicket = async () => {
        if (!ticketSubject.trim() || !ticketMessage.trim()) {
          alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–º—É –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ');
          return;
        }
        try {
          const res = await fetch('/api/tickets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ subject: ticketSubject, message: ticketMessage })
          });
          const newTicket = await res.json();
          if (!res.ok) throw new Error(newTicket.error);
          setTickets([newTicket, ...tickets]);
          setTicketSubject('');
          setTicketMessage('');
          setShowNewTicket(false);
          alert('–û–±—Ä–∞—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ! –ú—ã –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º soon.');
        } catch (e) {
          alert(e.message);
        }
      };

      const handleSendReply = async () => {
        if (!replyMessage.trim() || !selectedTicket) return;
        try {
          const res = await fetch(`/api/tickets/${selectedTicket.id}/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ text: replyMessage })
          });
          const updatedTicket = await res.json();
          if (!res.ok) throw new Error(updatedTicket.error);
          setTickets(tickets.map(t => t.id === updatedTicket.id ? updatedTicket : t));
          setSelectedTicket(updatedTicket);
          setReplyMessage('');
        } catch (e) {
          alert(e.message);
        }
      };

      const handleAISend = async () => {
        if (!aiInput.trim()) return;
        const userMsg = aiInput.trim();
        setAiMessages([...aiMessages, { from: 'user', text: userMsg }]);
        setAiInput('');
        setAiLoading(true);
        try {
          const res = await fetch('/api/ai/ask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userMsg, context: aiMessages.slice(-5) })
          });
          const data = await res.json();
          setAiMessages(prev => [...prev, { from: 'ai', text: data.response }]);
        } catch (e) {
          setAiMessages(prev => [...prev, { from: 'ai', text: '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.' }]);
        }
        setAiLoading(false);
      };

      const getMonthlySummary = () => {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        
        const monthlyPurchases = purchases.filter(p => {
          const d = new Date(p.date);
          return d.getMonth() === currentMonth && d.getFullYear() === currentYear && p.branchId === currentBranchId;
        });
        
        const monthlySales = sales.filter(s => {
          const d = new Date(s.date);
          return d.getMonth() === currentMonth && d.getFullYear() === currentYear && s.branchId === currentBranchId;
        });
        
        const productSummary = {};
        
        monthlyPurchases.forEach(p => {
          if (!productSummary[p.productName]) {
            productSummary[p.productName] = { purchased: 0, sold: 0, purchaseAmount: 0, saleAmount: 0, profit: 0 };
          }
          productSummary[p.productName].purchased += p.quantity;
          productSummary[p.productName].purchaseAmount += p.total;
        });
        
        monthlySales.forEach(s => {
          if (!productSummary[s.productName]) {
            productSummary[s.productName] = { purchased: 0, sold: 0, purchaseAmount: 0, saleAmount: 0, profit: 0 };
          }
          productSummary[s.productName].sold += s.quantity;
          productSummary[s.productName].saleAmount += s.totalRevenue;
          productSummary[s.productName].profit += s.profit;
        });
        
        return { monthlyPurchases, monthlySales, productSummary };
      };

      const getAvailableProducts = () => {
        const productMap = {};
        purchases.filter(p => p.branchId === currentBranchId).forEach(p => {
          if (!productMap[p.productName]) {
            productMap[p.productName] = { name: p.productName, photo: p.photo, remaining: 0 };
          }
          productMap[p.productName].remaining += p.remainingQty;
        });
        return Object.values(productMap).filter(p => p.remaining > 0);
      };

      if (loading) {
        return (
          <div className="loading">
            <div>
              <div className="loading-icon">üìä</div>
              <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
          </div>
        );
      }


      // Landing Page
      if (showLanding && !token) {
        return (
          <div className="landing-page">
            <div className="landing-hero">
              <h1>ProfitTrack</h1>
              <p>–£–º–Ω—ã–π —É—á–µ—Ç –∑–∞–∫—É–ø–æ–∫ –∏ –ø—Ä–æ–¥–∞–∂ –¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–∏–±—ã–ª—å, —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –∑–∞–ø–∞—Å–∞–º–∏ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–æ–¥–∞–∂–∏.</p>
              <div>
                <button className="landing-btn" onClick={() => setShowLanding(false)}>–ù–∞—á–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
                <button className="landing-btn landing-btn-outline" onClick={() => { setShowLanding(false); setAuthMode('login'); }}>–í–æ–π—Ç–∏</button>
              </div>
              <div className="landing-stats">
                <div className="landing-stat">
                  <div className="landing-stat-value">15,000+</div>
                  <div className="landing-stat-label">–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
                <div className="landing-stat">
                  <div className="landing-stat-value">500+</div>
                  <div className="landing-stat-label">–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤</div>
                </div>
                <div className="landing-stat">
                  <div className="landing-stat-value">‚Ç¨2M+</div>
                  <div className="landing-stat-label">–æ—Ç—Å–ª–µ–∂–µ–Ω–æ –ø—Ä–æ–¥–∞–∂</div>
                </div>
              </div>
            </div>

            <div className="landing-section">
              <h2>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h2>
              <div className="features-grid">
                <div className="feature-card">
                  <div className="feature-icon">üìä</div>
                  <h3>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –ø—Ä–∏–±—ã–ª–∏</h3>
                  <p>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞–µ—Ç –≤–∞—à—É –ø—Ä–∏–±—ã–ª—å –ø–æ –∫–∞–∂–¥–æ–π –ø—Ä–æ–¥–∞–∂–µ</p>
                </div>
                <div className="feature-card">
                  <div className="feature-icon">üì∏</div>
                  <h3>–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–æ–≤</h3>
                  <p>–î–æ–±–∞–≤–ª—è–π—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∫ –∑–∞–∫—É–ø–∫–∞–º - –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥—Ä—É–∑—è—Ç—Å—è –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ</p>
                </div>
                <div className="feature-card">
                  <div className="feature-icon">üìù</div>
                  <h3>–ó–∞–º–µ—Ç–∫–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏—è</h3>
                  <p>–í–µ–¥–∏—Ç–µ –∑–∞–º–µ—Ç–∫–∏ –∫ –∫–∞–∂–¥–æ–π —Å–¥–µ–ª–∫–µ: –∫–æ–Ω—Ç–∞–∫—Ç—ã, —É—Å–ª–æ–≤–∏—è, –º–µ—Å—Ç–æ –ø—Ä–æ–¥–∞–∂–∏</p>
                </div>
                <div className="feature-card">
                  <div className="feature-icon">üè∑Ô∏è</div>
                  <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤</h3>
                  <p>–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≤–µ—Ç–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Ç–æ–≤–∞—Ä–æ–≤</p>
                </div>
                <div className="feature-card">
                  <div className="feature-icon">üì¶</div>
                  <h3>–£—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤</h3>
                  <p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –ø—Ä–æ–¥–∞–∂–∏</p>
                </div>
                <div className="feature-card">
                  <div className="feature-icon">üìÖ</div>
                  <h3>–ú–µ—Å—è—á–Ω–∞—è —Å–≤–æ–¥–∫–∞</h3>
                  <p>–ü–æ–ª—É—á–∞–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞–∂–¥–æ–º—É —Ç–æ–≤–∞—Ä—É –∑–∞ –º–µ—Å—è—Ü</p>
                </div>
              </div>
            </div>

            <div className="landing-section" style={{ background: 'var(--bg-secondary)' }}>
              <h2>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h2>
              <div className="screenshots-grid">
                <div className="screenshot-card">
                  <div className="screenshot-img">üì•</div>
                  <div className="screenshot-content">
                    <h3>1. –î–æ–±–∞–≤—å—Ç–µ –∑–∞–∫—É–ø–∫—É</h3>
                    <p>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ü–µ–Ω—É –∑–∞–∫—É–ø–∫–∏.</p>
                  </div>
                </div>
                <div className="screenshot-card">
                  <div className="screenshot-img">üì§</div>
                  <div className="screenshot-content">
                    <h3>2. –û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä–æ–¥–∞–∂—É</h3>
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä, —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏.</p>
                  </div>
                </div>
                <div className="screenshot-card">
                  <div className="screenshot-img">üí∞</div>
                  <div className="screenshot-content">
                    <h3>3. –°–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä–∏–±—ã–ª—å</h3>
                    <p>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞–µ—Ç –ø—Ä–∏–±—ã–ª—å.</p>
                  </div>
                </div>
              </div>
            </div>

            <div className="landing-section reviews-section">
              <h2>–û—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
              <div className="reviews-grid">
                {reviews.slice(0, 6).map(review => (
                  <div key={review.id} className="review-card">
                    <div className="review-header">
                      <div className="review-avatar">{review.name.charAt(0)}</div>
                      <div className="review-info">
                        <h4>{review.name}</h4>
                        <div className="review-stars">{'‚òÖ'.repeat(review.rating)}{'‚òÜ'.repeat(5 - review.rating)}</div>
                      </div>
                    </div>
                    <p className="review-text">{review.text}</p>
                  </div>
                ))}
              </div>
              
              {token && (
                <div className="review-form">
                  <h3>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>
                  <div className="star-rating">
                    {[1, 2, 3, 4, 5].map(star => (
                      <button key={star} className={`star-btn ${star <= newReviewRating ? 'active' : ''}`} onClick={() => setNewReviewRating(star)}>‚òÖ</button>
                    ))}
                  </div>
                  <div className="form-group">
                    <textarea placeholder="–í–∞—à –æ—Ç–∑—ã–≤..." value={newReviewText} onChange={(e) => setNewReviewText(e.target.value)} rows={3} />
                  </div>
                  <button className="btn btn-primary" onClick={handleAddReview}>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                </div>
              )}
              
              {!token && (
                <div style={{ textAlign: 'center', marginTop: '32px' }}>
                  <button className="landing-btn" onClick={() => setShowLanding(false)}>–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                </div>
              )}
            </div>

            <div className="landing-footer">
              <p>¬© 2024 ProfitTrack. –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.</p>
            </div>
          </div>
        );
      }

      // Auth Screen
      if (!token) {
        return (
          <div className="auth-container">
            <div className="auth-card">
              <div className="auth-header">
                <h1>ProfitTrack</h1>
                <p>–£—á–µ—Ç –∑–∞–∫—É–ø–æ–∫ –∏ –ø—Ä–æ–¥–∞–∂ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–∞—Å—á–µ—Ç–æ–º –ø—Ä–∏–±—ã–ª–∏</p>
              </div>
              <div className="auth-form">
                {showForgotPassword ? (
                  <>
                    <h2 style={{ marginBottom: '16px', color: 'var(--text-primary)' }}>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h2>
                    {resetStep === 1 && (
                      <>
                        <div className="form-group">
                          <label>Email <span className="required">*</span></label>
                          <input type="email" placeholder="your@email.com" value={resetEmail} onChange={(e) => setResetEmail(e.target.value)} />
                        </div>
                        {authError && <div className="auth-error">{authError}</div>}
                        {authSuccess && <div className="auth-success">{authSuccess}</div>}
                        <button className="auth-btn" onClick={handleForgotPassword} disabled={authLoading}>
                          {authLoading ? '–û—Ç–ø—Ä–∞–≤–∫–∞...' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥'}
                        </button>
                      </>
                    )}
                    {resetStep === 2 && (
                      <>
                        <div className="info-box">–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ {resetEmail}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É "–°–ø–∞–º". –ö–æ–¥ –≤ –ø–∏—Å—å–º–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ.</div>
                        <div className="form-group">
                          <label>–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</label>
                          <input type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞" value={resetCode} onChange={(e) => setResetCode(e.target.value)} />
                        </div>
                        {authError && <div className="auth-error">{authError}</div>}
                        <button className="auth-btn" onClick={handleVerifyCode} disabled={authLoading}>
                          {authLoading ? '–ü—Ä–æ–≤–µ—Ä–∫–∞...' : '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å'}
                        </button>
                      </>
                    )}
                    {resetStep === 3 && (
                      <>
                        <div className="form-group">
                          <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                          <div className="password-input-wrapper">
                            <input type={showResetPassword ? 'text' : 'password'} placeholder="–ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞" value={newResetPassword} onChange={(e) => setNewResetPassword(e.target.value)} />
                            <button type="button" className="password-toggle" onClick={() => setShowResetPassword(!showResetPassword)}>
                              {showResetPassword ? 'üôà' : 'üëÅÔ∏è'}
                            </button>
                          </div>
                        </div>
                        <div className="form-group">
                          <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                          <div className="password-input-wrapper">
                            <input type={showResetPassword ? 'text' : 'password'} placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} />
                          </div>
                        </div>
                        {authError && <div className="auth-error">{authError}</div>}
                        {authSuccess && <div className="auth-success">{authSuccess}</div>}
                        <button className="auth-btn" onClick={handleResetPassword} disabled={authLoading || newResetPassword !== confirmPassword}>
                          {authLoading ? '–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è...' : '–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å'}
                        </button>
                      </>
                    )}
                    <div className="back-to-login">
                      <button onClick={() => { setShowForgotPassword(false); setResetStep(1); setAuthError(''); setAuthSuccess(''); }}>‚Üê –ù–∞–∑–∞–¥ –∫ –≤—Ö–æ–¥—É</button>
                    </div>
                  </>
                ) : (
                  <>
                    <div className="auth-tabs">
                      <button className={`auth-tab ${authMode === 'login' ? 'active' : ''}`} onClick={() => setAuthMode('login')}>–í—Ö–æ–¥</button>
                      <button className={`auth-tab ${authMode === 'register' ? 'active' : ''}`} onClick={() => setAuthMode('register')}>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                    </div>
                    
                    {authMode === 'register' && (
                      <div className="form-group">
                        <label>–í–∞—à–µ –∏–º—è</label>
                        <input type="text" placeholder="–ò–≤–∞–Ω" value={userName} onChange={(e) => setUserName(e.target.value)} />
                      </div>
                    )}
                    
                    <div className="form-group">
                      <label>–õ–æ–≥–∏–Ω –∏–ª–∏ Email</label>
                      <input type="text" placeholder="ivan123 –∏–ª–∏ email@example.com" value={loginInput} onChange={(e) => setLoginInput(e.target.value)} />
                    </div>
                    
                    {authMode === 'register' && (
                      <div className="form-group">
                        <label>Email <span className="required">*</span></label>
                        <input type="email" placeholder="your@email.com" value={emailInput} onChange={(e) => setEmailInput(e.target.value)} />
                        <small style={{ color: 'var(--text-secondary)', fontSize: '12px' }}>–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è</small>
                      </div>
                    )}
                    
                    <div className="form-group">
                      <label>–ü–∞—Ä–æ–ª—å</label>
                      <div className="password-input-wrapper">
                        <input type={showPassword ? 'text' : 'password'} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={passwordInput} onChange={(e) => setPasswordInput(e.target.value)} />
                        <button type="button" className="password-toggle" onClick={() => setShowPassword(!showPassword)}>
                          {showPassword ? 'üôà' : 'üëÅÔ∏è'}
                        </button>
                      </div>
                    </div>
                    
                    {authError && <div className="auth-error">{authError}</div>}
                    
                    <button className="auth-btn" onClick={authMode === 'login' ? handleLogin : handleRegister} disabled={authLoading}>
                      {authLoading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : (authMode === 'login' ? '–í–æ–π—Ç–∏' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è')}
                    </button>
                    
                    {authMode === 'login' && (
                      <div className="forgot-password">
                        <button onClick={() => { setShowForgotPassword(true); setAuthError(''); }}>–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
                      </div>
                    )}
                    
                    <div className="back-to-login">
                      <button onClick={() => setShowLanding(true)}>‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>
        );
      }

      const availableProducts = getAvailableProducts();
      const { monthlyPurchases, monthlySales, productSummary } = getMonthlySummary();

      const totalPurchases = purchases.filter(p => p.branchId === currentBranchId).reduce((sum, p) => sum + p.total, 0);
      const branchSales = sales.filter(s => s.branchId === currentBranchId);
      const totalSales = branchSales.reduce((sum, s) => sum + s.totalRevenue, 0);
      const totalProfit = branchSales.reduce((sum, s) => sum + s.profit, 0);

      return (
        <div>
          <header className="app-header">
            <div className="app-header-content">
              <div className="header-left">
                <button className="menu-btn" onClick={() => setSidebarOpen(true)}>‚ò∞</button>
                <div className="logo">
                  <span className="logo-icon">üìä</span>
                  <div className="logo-text">
                    <h1>ProfitTrack</h1>
                  </div>
                </div>
              </div>
              <div className="user-info">
                <span style={{ color: 'var(--text-secondary)' }}>üë§ {user?.name}</span>
                <button className="logout-btn" onClick={handleLogout}>–í—ã–π—Ç–∏</button>
              </div>
            </div>
          </header>

          {sidebarOpen && <div className="sidebar-overlay" onClick={() => setSidebarOpen(false)} />}
          <div className={`sidebar ${sidebarOpen ? 'open' : ''}`}>
            <div className="sidebar-header">
              <h2>–ú–µ–Ω—é</h2>
              <button className="close-sidebar" onClick={() => setSidebarOpen(false)}>‚úï</button>
            </div>
            <div className="sidebar-menu">
              <button className="sidebar-item" onClick={() => { setShowProfile(true); setSidebarOpen(false); }}>üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
              <button className="sidebar-item" onClick={() => { setActiveTab('add'); setSidebarOpen(false); setShowSupport(false); }}>‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
              <button className="sidebar-item" onClick={() => { setActiveTab('history'); setSidebarOpen(false); setShowSupport(false); }}>üìã –ò—Å—Ç–æ—Ä–∏—è</button>
              <button className="sidebar-item" onClick={() => { setActiveTab('summary'); setSidebarOpen(false); setShowSupport(false); }}>üìä –°–≤–æ–¥–∫–∞</button>
              <button className="sidebar-item" onClick={() => { setShowSupport(true); setSidebarOpen(false); }}>üéß –ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
              <div className="sidebar-divider" />
              <div className="theme-toggle">
                <span>üåô –¢–µ–º–Ω–∞—è —Ç–µ–º–∞</span>
                <div className={`toggle-switch ${theme === 'dark' ? 'active' : ''}`} onClick={toggleTheme} />
              </div>
              <div className="sidebar-divider" />
              <button className="sidebar-item" onClick={handleLogout}>üö™ –í—ã–π—Ç–∏</button>
            </div>
          </div>

          {showProfile && (
            <div className="modal-overlay" onClick={() => setShowProfile(false)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                  <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
                  <button className="close-modal" onClick={() => setShowProfile(false)}>‚úï</button>
                </div>
                <div style={{ marginBottom: '24px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '16px' }}>
                    <div className="profile-avatar">{user?.name?.charAt(0) || '?'}</div>
                    <div>
                      <h4>{user?.name}</h4>
                      <p style={{ fontSize: '14px', color: 'var(--text-secondary)' }}>@{user?.login}</p>
                      {user?.email && <p style={{ fontSize: '12px', color: '#6b7280' }}>üìß {user.email}</p>}
                    </div>
                  </div>
                </div>
                <div style={{ marginBottom: '24px' }}>
                  <h3 style={{ fontSize: '16px', color: 'var(--text-secondary)', marginBottom: '12px' }}>Email</h3>
                  <div className="form-group">
                    <input type="email" placeholder="your@email.com" defaultValue={user?.email || ''} onChange={(e) => setEmailInput(e.target.value)} />
                  </div>
                  <button className="btn btn-secondary" onClick={handleUpdateEmail}>–û–±–Ω–æ–≤–∏—Ç—å email</button>
                </div>
                <div>
                  <h3 style={{ fontSize: '16px', color: 'var(--text-secondary)', marginBottom: '12px' }}>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h3>
                  <button className="btn btn-primary" onClick={() => { setShowChangePassword(true); setShowProfile(false); }}>–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                </div>
              </div>
            </div>
          )}

          {showChangePassword && (
            <div className="modal-overlay" onClick={() => setShowChangePassword(false)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                  <h2>–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h2>
                  <button className="close-modal" onClick={() => setShowChangePassword(false)}>‚úï</button>
                </div>
                {passwordError && <div className="auth-error">{passwordError}</div>}
                {passwordSuccess && <div className="auth-success">{passwordSuccess}</div>}
                <div className="form-group">
                  <label>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                  <div className="password-input-wrapper">
                    <input type={showCurrentPassword ? 'text' : 'password'} value={currentPassword} onChange={(e) => setCurrentPassword(e.target.value)} />
                    <button type="button" className="password-toggle" onClick={() => setShowCurrentPassword(!showCurrentPassword)}>
                      {showCurrentPassword ? 'üôà' : 'üëÅÔ∏è'}
                    </button>
                  </div>
                </div>
                <div className="form-group">
                  <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                  <div className="password-input-wrapper">
                    <input type={showNewPassword ? 'text' : 'password'} value={newPassword} onChange={(e) => setNewPassword(e.target.value)} />
                    <button type="button" className="password-toggle" onClick={() => setShowNewPassword(!showNewPassword)}>
                      {showNewPassword ? 'üôà' : 'üëÅÔ∏è'}
                    </button>
                  </div>
                </div>
                <div className="form-group">
                  <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                  <div className="password-input-wrapper">
                    <input type={showConfirmPassword ? 'text' : 'password'} value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} />
                    <button type="button" className="password-toggle" onClick={() => setShowConfirmPassword(!showConfirmPassword)}>
                      {showConfirmPassword ? 'üôà' : 'üëÅÔ∏è'}
                    </button>
                  </div>
                </div>
                <button className="auth-btn" onClick={handleChangePassword}>–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
              </div>
            </div>
          )}

          {showSupport && (
            <div className="modal-overlay" onClick={() => setShowSupport(false)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '700px', maxHeight: '85vh' }}>
                <div className="modal-header">
                  <h2>üéß –ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
                  <button className="close-modal" onClick={() => setShowSupport(false)}>‚úï</button>
                </div>
                
                {!showNewTicket && !selectedTicket && (
                  <div>
                    {/* FAQ Section */}
                    <div style={{ marginBottom: '24px' }}>
                      <h3 style={{ fontSize: '18px', marginBottom: '12px', color: 'var(--text-primary)' }}>‚ùì –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h3>
                      <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                        {faq.map((item, idx) => (
                          <div key={item.id} style={{ border: '1px solid var(--border-color)', borderRadius: '8px', marginBottom: '8px', overflow: 'hidden' }}>
                            <button 
                              onClick={() => setExpandedFAQ(expandedFAQ === idx ? null : idx)}
                              style={{ 
                                width: '100%', 
                                padding: '12px 16px', 
                                textAlign: 'left', 
                                background: expandedFAQ === idx ? 'var(--bg-primary)' : 'var(--bg-card)',
                                border: 'none',
                                cursor: 'pointer',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                color: 'var(--text-primary)'
                              }}
                            >
                              <span>{item.question}</span>
                              <span>{expandedFAQ === idx ? '‚ñ≤' : '‚ñº'}</span>
                            </button>
                            {expandedFAQ === idx && (
                              <div style={{ padding: '12px 16px', background: 'var(--bg-primary)', color: 'var(--text-secondary)', fontSize: '14px', lineHeight: '1.5' }}>
                                {item.answer}
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Tickets Section */}
                    <div>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                        <h3 style={{ fontSize: '18px', color: 'var(--text-primary)' }}>üé´ –ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h3>
                        <button className="btn btn-primary" onClick={() => setShowNewTicket(true)}>+ –ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>
                      </div>
                      {tickets.length === 0 ? (
                        <p style={{ color: 'var(--text-secondary)', textAlign: 'center', padding: '24px' }}>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π</p>
                      ) : (
                        <div style={{ maxHeight: '250px', overflowY: 'auto' }}>
                          {tickets.map(ticket => (
                            <div 
                              key={ticket.id} 
                              onClick={() => setSelectedTicket(ticket)}
                              style={{ 
                                padding: '12px 16px', 
                                border: '1px solid var(--border-color)', 
                                borderRadius: '8px', 
                                marginBottom: '8px',
                                cursor: 'pointer',
                                background: 'var(--bg-card)'
                              }}
                            >
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span style={{ fontWeight: '600', color: 'var(--text-primary)' }}>{ticket.subject}</span>
                                <span className={`badge ${ticket.status === 'open' ? 'badge-success' : 'badge-info'}`}>
                                  {ticket.status === 'open' ? '–û—Ç–∫—Ä—ã—Ç' : '–ó–∞–∫—Ä—ã—Ç'}
                                </span>
                              </div>
                              <p style={{ fontSize: '12px', color: 'var(--text-secondary)', marginTop: '4px' }}>
                                {new Date(ticket.createdAt).toLocaleDateString('ru-RU')} ¬∑ {ticket.messages.length} —Å–æ–æ–±—â–µ–Ω–∏–π
                              </p>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {showNewTicket && (
                  <div>
                    <button className="btn" style={{ background: 'var(--bg-primary)', color: 'var(--text-primary)', marginBottom: '16px' }} onClick={() => setShowNewTicket(false)}>‚Üê –ù–∞–∑–∞–¥</button>
                    <h3 style={{ fontSize: '18px', marginBottom: '16px', color: 'var(--text-primary)' }}>–ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ</h3>
                    <div className="form-group">
                      <label>–¢–µ–º–∞</label>
                      <input type="text" placeholder="–û–ø–∏—à–∏—Ç–µ –∫—Ä–∞—Ç–∫–æ –ø—Ä–æ–±–ª–µ–º—É" value={ticketSubject} onChange={(e) => setTicketSubject(e.target.value)} />
                    </div>
                    <div className="form-group">
                      <label>–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                      <textarea placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –≤–æ–ø—Ä–æ—Å..." value={ticketMessage} onChange={(e) => setTicketMessage(e.target.value)} rows={5} />
                    </div>
                    <button className="btn btn-primary" onClick={handleCreateTicket} disabled={!ticketSubject.trim() || !ticketMessage.trim()}>
                      –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ
                    </button>
                  </div>
                )}

                {selectedTicket && (
                  <div>
                    <button className="btn" style={{ background: 'var(--bg-primary)', color: 'var(--text-primary)', marginBottom: '16px' }} onClick={() => setSelectedTicket(null)}>‚Üê –ù–∞–∑–∞–¥</button>
                    <h3 style={{ fontSize: '18px', marginBottom: '8px', color: 'var(--text-primary)' }}>{selectedTicket.subject}</h3>
                    <div style={{ maxHeight: '300px', overflowY: 'auto', marginBottom: '16px', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px' }}>
                      {selectedTicket.messages.map((msg, idx) => (
                        <div key={msg.id} style={{ marginBottom: '12px', textAlign: msg.from === 'user' ? 'right' : 'left' }}>
                          <div 
                            style={{ 
                              display: 'inline-block',
                              padding: '10px 14px', 
                              borderRadius: '12px',
                              background: msg.from === 'user' ? '#3b82f6' : 'var(--bg-card)',
                              color: msg.from === 'user' ? 'white' : 'var(--text-primary)',
                              border: msg.from === 'user' ? 'none' : '1px solid var(--border-color)',
                              maxWidth: '80%',
                              textAlign: 'left'
                            }}
                          >
                            <p style={{ margin: 0 }}>{msg.text}</p>
                            <small style={{ fontSize: '11px', opacity: 0.7, display: 'block', marginTop: '4px' }}>
                              {new Date(msg.createdAt).toLocaleString('ru-RU')}
                            </small>
                          </div>
                        </div>
                      ))}
                    </div>
                    <div style={{ display: 'flex', gap: '8px' }}>
                      <input 
                        type="text" 
                        placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..." 
                        value={replyMessage} 
                        onChange={(e) => setReplyMessage(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && handleSendReply()}
                        style={{ flex: 1, padding: '10px', borderRadius: '8px', border: '1px solid var(--input-border)', background: 'var(--input-bg)', color: 'var(--text-primary)' }}
                      />
                      <button className="btn btn-primary" onClick={handleSendReply} disabled={!replyMessage.trim()}>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* AI Chat Widget */}
          {token && (
            <div style={{ position: 'fixed', bottom: '20px', right: '20px', zIndex: 500 }}>
              {!aiChatOpen && (
                <button 
                  onClick={() => setAiChatOpen(true)}
                  style={{ 
                    width: '60px', 
                    height: '60px', 
                    borderRadius: '50%', 
                    background: 'linear-gradient(135deg, #667eea, #764ba2)', 
                    color: 'white',
                    border: 'none',
                    fontSize: '24px',
                    cursor: 'pointer',
                    boxShadow: '0 4px 12px rgba(0,0,0,0.3)'
                  }}
                >
                  ü§ñ
                </button>
              )}
              {aiChatOpen && (
                <div style={{ 
                  width: '350px', 
                  height: '450px', 
                  background: 'var(--bg-card)', 
                  borderRadius: '16px', 
                  boxShadow: '0 10px 40px rgba(0,0,0,0.3)',
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden',
                  border: '1px solid var(--border-color)'
                }}>
                  <div style={{ 
                    padding: '16px', 
                    background: 'linear-gradient(135deg, #667eea, #764ba2)', 
                    color: 'white',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                  }}>
                    <span style={{ fontWeight: '600' }}>ü§ñ –ò–ò-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
                    <button onClick={() => setAiChatOpen(false)} style={{ background: 'none', border: 'none', color: 'white', fontSize: '20px', cursor: 'pointer' }}>‚úï</button>
                  </div>
                  <div style={{ flex: 1, overflowY: 'auto', padding: '16px' }}>
                    {aiMessages.map((msg, idx) => (
                      <div key={idx} style={{ marginBottom: '12px', textAlign: msg.from === 'user' ? 'right' : 'left' }}>
                        <div 
                          style={{ 
                            display: 'inline-block',
                            padding: '10px 14px', 
                            borderRadius: '12px',
                            background: msg.from === 'user' ? '#3b82f6' : 'var(--bg-primary)',
                            color: msg.from === 'user' ? 'white' : 'var(--text-primary)',
                            border: msg.from === 'user' ? 'none' : '1px solid var(--border-color)',
                            maxWidth: '85%',
                            textAlign: 'left',
                            fontSize: '14px',
                            lineHeight: '1.4'
                          }}
                        >
                          {msg.text}
                        </div>
                      </div>
                    ))}
                    {aiLoading && (
                      <div style={{ textAlign: 'left' }}>
                        <div style={{ display: 'inline-block', padding: '10px 14px', background: 'var(--bg-primary)', borderRadius: '12px' }}>
                          <span style={{ fontSize: '20px', animation: 'pulse 1s infinite' }}>‚Ä¢‚Ä¢‚Ä¢</span>
                        </div>
                      </div>
                    )}
                  </div>
                  <div style={{ padding: '12px', borderTop: '1px solid var(--border-color)', display: 'flex', gap: '8px' }}>
                    <input 
                      type="text" 
                      placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..." 
                      value={aiInput} 
                      onChange={(e) => setAiInput(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleAISend()}
                      style={{ flex: 1, padding: '10px', borderRadius: '8px', border: '1px solid var(--input-border)', background: 'var(--input-bg)', color: 'var(--text-primary)' }}
                    />
                    <button 
                      onClick={handleAISend} 
                      disabled={!aiInput.trim() || aiLoading}
                      style={{ 
                        padding: '10px 16px', 
                        background: '#3b82f6', 
                        color: 'white', 
                        border: 'none', 
                        borderRadius: '8px',
                        cursor: 'pointer'
                      }}
                    >
                      ‚û§
                    </button>
                  </div>
                </div>
              )}
            </div>
          )}

          <main className="main-content">
            <div className="stats-grid">
              <div className="stat-card purchases">
                <div>
                  <div className="stat-label">–í—Å–µ–≥–æ –∑–∞–∫—É–ø–æ–∫</div>
                  <div className="stat-value purchases">{formatCurrency(totalPurchases)}</div>
                </div>
                <div className="stat-icon purchases">üì¶</div>
              </div>
              <div className="stat-card sales">
                <div>
                  <div className="stat-label">–í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–∂</div>
                  <div className="stat-value sales">{formatCurrency(totalSales)}</div>
                </div>
                <div className="stat-icon sales">üõí</div>
              </div>
              <div className="stat-card" style={{ borderColor: '#ddd6fe' }}>
                <div>
                  <div className="stat-label">–í—ã—Ä—É—á–∫–∞</div>
                  <div className="stat-value" style={{ color: '#7c3aed' }}>{formatCurrency(totalSales)}</div>
                </div>
                <div className="stat-icon" style={{ background: '#ede9fe' }}>üí∞</div>
              </div>
              <div className={`stat-card profit ${totalProfit < 0 ? 'negative' : ''}`}>
                <div>
                  <div className="stat-label">–ü—Ä–∏–±—ã–ª—å</div>
                  <div className={`stat-value profit ${totalProfit < 0 ? 'negative' : ''}`}>{formatCurrency(totalProfit)}</div>
                </div>
                <div className={`stat-icon profit ${totalProfit < 0 ? 'negative' : ''}`}>üìà</div>
              </div>
            </div>

            <div className="branch-selector">
              <div className="branch-controls">
                <select className="branch-select" value={currentBranchId} onChange={(e) => setCurrentBranchId(e.target.value)}>
                  {branches.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                </select>
                <button className="btn-small" style={{ background: '#10b981', color: 'white' }} onClick={() => setShowNewBranchForm(!showNewBranchForm)}>+ –ù–æ–≤–∞—è –≤–µ—Ç–∫–∞</button>
                {branches.length > 1 && (
                  <button className="btn-small" style={{ background: '#dc2626', color: 'white' }} onClick={() => deleteBranch(currentBranchId)}>–£–¥–∞–ª–∏—Ç—å</button>
                )}
              </div>
              {showNewBranchForm && (
                <div style={{ marginTop: '12px', display: 'flex', gap: '8px' }}>
                  <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏" value={newBranchName} onChange={(e) => setNewBranchName(e.target.value)} style={{ flex: 1, padding: '8px', borderRadius: '6px', border: '1px solid var(--input-border)', background: 'var(--input-bg)', color: 'var(--text-primary)' }} />
                  <button className="btn-small" style={{ background: '#10b981', color: 'white' }} onClick={createBranch}>–°–æ–∑–¥–∞—Ç—å</button>
                  <button className="btn-small" style={{ background: '#6b7280', color: 'white' }} onClick={() => setShowNewBranchForm(false)}>–û—Ç–º–µ–Ω–∞</button>
                </div>
              )}
            </div>

            <div className="tabs">
              <button className={`tab ${activeTab === 'add' ? 'active' : ''}`} onClick={() => setActiveTab('add')}>‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
              <button className={`tab ${activeTab === 'history' ? 'active' : ''}`} onClick={() => setActiveTab('history')}>üìã –ò—Å—Ç–æ—Ä–∏—è</button>
              <button className={`tab ${activeTab === 'summary' ? 'active' : ''}`} onClick={() => setActiveTab('summary')}>üìä –°–≤–æ–¥–∫–∞</button>
            </div>

            <div className="tab-content">
              {activeTab === 'add' && (
                <div className="form-grid">
                  <div className="form-card purchase">
                    <h3>üì¶ –ù–æ–≤–∞—è –∑–∞–∫—É–ø–∫–∞</h3>
                    <div className="form-group">
                      <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
                      <input type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: iPhone 15" value={purchaseName} onChange={(e) => setPurchaseName(e.target.value)} />
                    </div>
                    <div className="form-row">
                      <div className="form-group">
                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                        <input type="number" min="1" placeholder="1" value={purchaseQty} onChange={(e) => setPurchaseQty(e.target.value)} />
                      </div>
                      <div className="form-group">
                        <label>–¶–µ–Ω–∞ –∑–∞ —à—Ç (‚Ç¨)</label>
                        <input type="number" min="0" step="0.01" placeholder="0.00" value={purchasePrice} onChange={(e) => setPurchasePrice(e.target.value)} />
                      </div>
                    </div>
                    <div className="form-group">
                      <label>–î–∞—Ç–∞</label>
                      <input type="date" value={purchaseDate} onChange={(e) => setPurchaseDate(e.target.value)} />
                    </div>
                    <div className="form-group">
                      <label>–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞</label>
                      <input type="file" accept="image/*" onChange={(e) => handlePhotoUpload(e, setPurchasePhoto)} />
                      {purchasePhoto && <img src={purchasePhoto} alt="Preview" onClick={() => { setPreviewPhoto(purchasePhoto); setShowPreview(true); }} className="product-img" style={{ width: '50px', height: '50px', marginTop: '8px' }} />}
                    </div>
                    <div className="form-group">
                      <label>–ó–∞–º–µ—Ç–∫–∏</label>
                      <textarea placeholder="–û–ø–∏—Å–∞–Ω–∏–µ, –ø–æ—Å—Ç–∞–≤—â–∏–∫, —É—Å–ª–æ–≤–∏—è..." value={purchaseNotes} onChange={(e) => setPurchaseNotes(e.target.value)} rows={2} />
                    </div>
                    {purchaseQty && purchasePrice && (
                      <div className="summary-box">
                        <p style={{ margin: 0, fontSize: '14px' }}>–ò—Ç–æ–≥–æ: <strong>{formatCurrency(Number(purchaseQty) * Number(purchasePrice))}</strong></p>
                      </div>
                    )}
                    <button className="btn btn-primary" style={{ marginTop: '12px', width: '100%' }} onClick={addPurchase} disabled={!purchaseName || !purchaseQty || !purchasePrice}>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫—É–ø–∫—É</button>
                  </div>

                  <div className="form-card sale">
                    <h3>üõí –ù–æ–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞</h3>
                    <div className="form-group">
                      <label>–¢–æ–≤–∞—Ä</label>
                      <select value={saleProduct} onChange={(e) => {
                        const selected = availableProducts.find(p => p.name === e.target.value);
                        setSaleProduct(e.target.value);
                        if (selected) {
                          const relevantPurchases = purchases.filter(p => 
                            p.branchId === currentBranchId && 
                            p.productName === selected.name && 
                            p.remainingQty > 0
                          );
                          const firstPurchase = relevantPurchases[0];
                          setSalePurchasePrice(firstPurchase?.price?.toString() || '0');
                        }
                      }}>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>
                        {availableProducts.map(p => (
                          <option key={p.name} value={p.name}>{p.name} (–æ—Å—Ç–∞–ª–æ—Å—å: {p.remaining})</option>
                        ))}
                      </select>
                    </div>
                    {saleProduct && availableProducts.find(p => p.name === saleProduct)?.photo && (
                      <div className="form-group">
                        <img src={availableProducts.find(p => p.name === saleProduct)?.photo} alt="Product" onClick={() => { setPreviewPhoto(availableProducts.find(p => p.name === saleProduct)?.photo); setShowPreview(true); }} className="product-img" style={{ width: '50px', height: '50px' }} />
                      </div>
                    )}
                    <div className="form-row">
                      <div className="form-group">
                        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                        <input type="number" min="1" placeholder="1" value={saleQty} onChange={(e) => setSaleQty(e.target.value)} />
                      </div>
                      <div className="form-group">
                        <label>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (‚Ç¨)</label>
                        <input type="number" min="0" step="0.01" placeholder="0.00" value={salePrice} onChange={(e) => setSalePrice(e.target.value)} />
                      </div>
                    </div>
                    <div className="form-group">
                      <label>–î–∞—Ç–∞</label>
                      <input type="date" value={saleDate} onChange={(e) => setSaleDate(e.target.value)} />
                    </div>
                    <div className="form-group">
                      <label>–ó–∞–º–µ—Ç–∫–∏</label>
                      <textarea placeholder="–ì–¥–µ –ø—Ä–æ–¥–∞–ª, –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª—è..." value={saleNotes} onChange={(e) => setSaleNotes(e.target.value)} rows={2} />
                    </div>
                    {saleQty && salePrice && salePurchasePrice && (
                      <div className={`summary-box ${Number(saleQty) * (Number(salePrice) - Number(salePurchasePrice)) < 0 ? 'negative' : ''}`}>
                        <p style={{ margin: 0, fontSize: '14px' }}>
                          –ü—Ä–∏–±—ã–ª—å: <strong style={{ color: Number(saleQty) * (Number(salePrice) - Number(salePurchasePrice)) >= 0 ? '#059669' : '#dc2626' }}>
                            {Number(saleQty) * (Number(salePrice) - Number(salePurchasePrice)) >= 0 ? '+' : ''}{formatCurrency(Number(saleQty) * (Number(salePrice) - Number(salePurchasePrice)))}
                          </strong>
                        </p>
                      </div>
                    )}
                    <button className="btn btn-secondary" style={{ marginTop: '12px', width: '100%' }} onClick={addSale} disabled={!saleProduct || !saleQty || !salePrice}>–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É</button>
                  </div>
                </div>
              )}

              {activeTab === 'history' && (
                <div>
                  <h3 style={{ marginBottom: '16px', color: 'var(--text-primary)' }}>üì¶ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫—É–ø–æ–∫</h3>
                  <div className="table-container">
                    <table>
                      <thead>
                        <tr>
                          <th>–§–æ—Ç–æ</th>
                          <th>–¢–æ–≤–∞—Ä</th>
                          <th>–ö–æ–ª-–≤–æ</th>
                          <th>–û—Å—Ç–∞–ª–æ—Å—å</th>
                          <th>–¶–µ–Ω–∞</th>
                          <th>–°—É–º–º–∞</th>
                          <th>–î–∞—Ç–∞</th>
                          <th>–ó–∞–º–µ—Ç–∫–∏</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                        {purchases.filter(p => p.branchId === currentBranchId).map(p => (
                          <tr key={p.id}>
                            <td>{p.photo ? <img src={p.photo} alt={p.productName} onClick={() => { setPreviewPhoto(p.photo); setShowPreview(true); }} className="product-img" /> : <div className="product-placeholder">üì¶</div>}</td>
                            <td>{p.productName}</td>
                            <td>{p.quantity}</td>
                            <td><span className={`badge ${p.remainingQty > 0 ? 'badge-info' : 'badge-warning'}`}>{p.remainingQty}</span></td>
                            <td>{formatCurrency(p.price)}</td>
                            <td>{formatCurrency(p.total)}</td>
                            <td>{new Date(p.date).toLocaleDateString('ru-RU')}</td>
                            <td>
                              {editingPurchaseId === p.id ? (
                                <div className="notes-input">
                                  <input type="text" value={editNotes} onChange={(e) => setEditNotes(e.target.value)} style={{ width: '100%', marginBottom: '4px' }} />
                                  <button className="edit-btn" onClick={() => savePurchaseNotes(p.id)}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                </div>
                              ) : (
                                <div>
                                  {p.notes && <div className="notes-box">{p.notes}</div>}
                                  <button className="edit-btn" onClick={() => { setEditingPurchaseId(p.id); setEditNotes(p.notes || ''); }}>{p.notes ? '–ò–∑–º–µ–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}</button>
                                </div>
                              )}
                            </td>
                            <td><button className="delete-btn" onClick={() => deletePurchase(p.id)}>üóëÔ∏è</button></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  <h3 style={{ margin: '32px 0 16px', color: 'var(--text-primary)' }}>üõí –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂</h3>
                  <div className="table-container">
                    <table>
                      <thead>
                        <tr>
                          <th>–§–æ—Ç–æ</th>
                          <th>–¢–æ–≤–∞—Ä</th>
                          <th>–ö–æ–ª-–≤–æ</th>
                          <th>–ó–∞–∫—É–ø–∫–∞</th>
                          <th>–ü—Ä–æ–¥–∞–∂–∞</th>
                          <th>–ü—Ä–∏–±—ã–ª—å</th>
                          <th>–î–∞—Ç–∞</th>
                          <th>–ó–∞–º–µ—Ç–∫–∏</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                        {sales.filter(s => s.branchId === currentBranchId).map(s => (
                          <tr key={s.id}>
                            <td>{s.photo ? <img src={s.photo} alt={s.productName} onClick={() => { setPreviewPhoto(s.photo); setShowPreview(true); }} className="product-img" /> : <div className="product-placeholder">üõí</div>}</td>
                            <td>{s.productName}</td>
                            <td>{s.quantity}</td>
                            <td>{formatCurrency(s.purchasePrice)}</td>
                            <td>{formatCurrency(s.salePrice)}</td>
                            <td><span className={`badge ${s.profit >= 0 ? 'badge-success' : 'badge-danger'}`}>{s.profit >= 0 ? '+' : ''}{formatCurrency(s.profit)}</span></td>
                            <td>{new Date(s.date).toLocaleDateString('ru-RU')}</td>
                            <td>
                              {editingSaleId === s.id ? (
                                <div className="notes-input">
                                  <input type="text" value={editNotes} onChange={(e) => setEditNotes(e.target.value)} style={{ width: '100%', marginBottom: '4px' }} />
                                  <button className="edit-btn" onClick={() => saveSaleNotes(s.id)}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                </div>
                              ) : (
                                <div>
                                  {s.notes && <div className="notes-box">{s.notes}</div>}
                                  <button className="edit-btn" onClick={() => { setEditingSaleId(s.id); setEditNotes(s.notes || ''); }}>{s.notes ? '–ò–∑–º–µ–Ω–∏—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å'}</button>
                                </div>
                              )}
                            </td>
                            <td><button className="delete-btn" onClick={() => deleteSale(s.id)}>üóëÔ∏è</button></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {activeTab === 'summary' && (
                <div>
                  <h3 style={{ marginBottom: '16px', color: 'var(--text-primary)' }}>üìä –°–≤–æ–¥–∫–∞ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</h3>
                  
                  <div className="stats-grid" style={{ marginBottom: '24px' }}>
                    <div className="stat-card purchases">
                      <div>
                        <div className="stat-label">–ó–∞–∫—É–ø–∫–∏</div>
                        <div className="stat-value purchases">{formatCurrency(monthlyPurchases.reduce((sum, p) => sum + p.total, 0))}</div>
                      </div>
                    </div>
                    <div className="stat-card sales">
                      <div>
                        <div className="stat-label">–ü—Ä–æ–¥–∞–∂–∏</div>
                        <div className="stat-value sales">{formatCurrency(monthlySales.reduce((sum, s) => sum + s.totalRevenue, 0))}</div>
                      </div>
                    </div>
                    <div className={`stat-card profit ${monthlySales.reduce((sum, s) => sum + s.profit, 0) < 0 ? 'negative' : ''}`}>
                      <div>
                        <div className="stat-label">–ü—Ä–∏–±—ã–ª—å</div>
                        <div className={`stat-value profit ${monthlySales.reduce((sum, s) => sum + s.profit, 0) < 0 ? 'negative' : ''}`}>
                          {formatCurrency(monthlySales.reduce((sum, s) => sum + s.profit, 0))}
                        </div>
                      </div>
                    </div>
                  </div>

                  <h4 style={{ marginBottom: '12px', color: 'var(--text-primary)' }}>–ü–æ —Ç–æ–≤–∞—Ä–∞–º:</h4>
                  <div className="table-container">
                    <table>
                      <thead>
                        <tr>
                          <th>–¢–æ–≤–∞—Ä</th>
                          <th>–ó–∞–∫—É–ø–ª–µ–Ω–æ</th>
                          <th>–ü—Ä–æ–¥–∞–Ω–æ</th>
                          <th>–ó–∞–∫—É–ø–∫–∞ (‚Ç¨)</th>
                          <th>–ü—Ä–æ–¥–∞–∂–∞ (‚Ç¨)</th>
                          <th>–ü—Ä–∏–±—ã–ª—å</th>
                        </tr>
                      </thead>
                      <tbody>
                        {Object.entries(productSummary).map(([name, data]) => (
                          <tr key={name}>
                            <td><strong>{name}</strong></td>
                            <td>{data.purchased} —à—Ç</td>
                            <td>{data.sold} —à—Ç</td>
                            <td>{formatCurrency(data.purchaseAmount)}</td>
                            <td>{formatCurrency(data.saleAmount)}</td>
                            <td><span className={`badge ${data.profit >= 0 ? 'badge-success' : 'badge-danger'}`}>{data.profit >= 0 ? '+' : ''}{formatCurrency(data.profit)}</span></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  <h4 style={{ margin: '24px 0 12px', color: 'var(--text-primary)' }}>üì¶ –¢–æ–≤–∞—Ä—ã –≤ –Ω–∞–ª–∏—á–∏–∏:</h4>
                  <div className="table-container">
                    <table>
                      <thead>
                        <tr>
                          <th>–§–æ—Ç–æ</th>
                          <th>–¢–æ–≤–∞—Ä</th>
                          <th>–û—Å—Ç–∞—Ç–æ–∫</th>
                          <th>–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏</th>
                          <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                        </tr>
                      </thead>
                      <tbody>
                        {availableProducts.map(p => (
                          <tr key={p.name}>
                            <td>{p.photo ? <img src={p.photo} alt={p.name} onClick={() => { setPreviewPhoto(p.photo); setShowPreview(true); }} className="product-img" style={{ width: '50px', height: '50px' }} /> : <div className="product-placeholder" style={{ width: '50px', height: '50px', fontSize: '24px' }}>üì¶</div>}</td>
                            <td><strong>{p.name}</strong></td>
                            <td><span className="badge badge-info">{p.remaining} —à—Ç</span></td>
                            <td>
                              {(() => {
                                const relevantPurchases = purchases.filter(pr => 
                                  pr.branchId === currentBranchId && 
                                  pr.productName === p.name && 
                                  pr.remainingQty > 0
                                );
                                const firstPurchase = relevantPurchases[0];
                                return firstPurchase ? formatCurrency(firstPurchase.price) : '-';
                              })()}
                            </td>
                            <td><button className="sell-btn" onClick={() => openQuickSale(p.name)}>–ü—Ä–æ–¥–∞—Ç—å</button></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  {availableProducts.length === 0 && (
                    <p style={{ textAlign: 'center', color: 'var(--text-secondary)', padding: '24px' }}>–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –Ω–∞–ª–∏—á–∏–∏</p>
                  )}
                </div>
              )}
            </div>
          </main>

          {showQuickSale && (
            <div className="modal-overlay" onClick={() => setShowQuickSale(false)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '400px' }}>
                <div className="modal-header">
                  <h2>üõí –ü—Ä–æ–¥–∞—Ç—å {quickSaleProduct}</h2>
                  <button className="close-modal" onClick={() => setShowQuickSale(false)}>‚úï</button>
                </div>
                <div>
                  {quickSalePhoto && <img src={quickSalePhoto} alt="Product" style={{ width: '100%', maxHeight: '200px', objectFit: 'contain', marginBottom: '16px', borderRadius: '8px' }} />}
                  <div className="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" min="1" placeholder="1" value={saleQty} onChange={(e) => setSaleQty(e.target.value)} />
                  </div>
                  <div className="form-group">
                    <label>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ (‚Ç¨)</label>
                    <input type="number" min="0" step="0.01" placeholder="0.00" value={salePrice} onChange={(e) => setSalePrice(e.target.value)} />
                  </div>
                  <div className="form-group">
                    <label>–î–∞—Ç–∞</label>
                    <input type="date" value={saleDate} onChange={(e) => setSaleDate(e.target.value)} />
                  </div>
                  <div className="form-group">
                    <label>–ó–∞–º–µ—Ç–∫–∏</label>
                    <textarea placeholder="–ì–¥–µ –ø—Ä–æ–¥–∞–ª, –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª—è..." value={saleNotes} onChange={(e) => setSaleNotes(e.target.value)} rows={2} />
                  </div>
                  {saleQty && salePrice && (
                    <div className={`summary-box ${Number(saleQty) * (Number(salePrice) - Number(quickSalePurchasePrice)) < 0 ? 'negative' : ''}`}>
                      <p style={{ margin: 0, fontSize: '14px' }}>
                        –ü—Ä–∏–±—ã–ª—å: <strong style={{ color: Number(saleQty) * (Number(salePrice) - Number(quickSalePurchasePrice)) >= 0 ? '#059669' : '#dc2626' }}>
                          {Number(saleQty) * (Number(salePrice) - Number(quickSalePurchasePrice)) >= 0 ? '+' : ''}{formatCurrency(Number(saleQty) * (Number(salePrice) - Number(quickSalePurchasePrice)))}
                        </strong>
                      </p>
                    </div>
                  )}
                  <div style={{ display: 'flex', gap: '8px', marginTop: '8px' }}>
                    <button className="btn btn-secondary" style={{ flex: 1 }} onClick={addQuickSale} disabled={!saleQty || !salePrice}>–ü—Ä–æ–¥–∞—Ç—å</button>
                    <button className="btn" style={{ background: '#6b7280', color: 'white' }} onClick={() => setShowQuickSale(false)}>–û—Ç–º–µ–Ω–∞</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {showPreview && (
            <div className="preview-modal" onClick={() => setShowPreview(false)}>
              <img src={previewPhoto} alt="Preview" onClick={(e) => e.stopPropagation()} />
              <button className="modal-close-btn" onClick={() => setShowPreview(false)}>‚úï</button>
            </div>
          )}

          <footer style={{ background: 'var(--bg-secondary)', borderTop: '1px solid var(--border-color)', marginTop: '48px' }}>
            <div style={{ maxWidth: '1280px', margin: '0 auto', padding: '16px 24px', textAlign: 'center' }}>
              <p style={{ fontSize: '14px', color: 'var(--text-secondary)', margin: 0 }}>–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ</p>
            </div>
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
